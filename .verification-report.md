# Verification Report: tmux-resurrect-claude-code Plugin

**Date:** 2026-02-10
**Reviewer:** Verification Agent (Claude Opus 4.6)
**Test Results:** 7/7 unit tests pass
**Shellcheck:** Not available on system (could not install without sudo)

---

## Summary

The plugin is **well-structured and mostly correct**. The core detection, save, and restore logic works properly. There are several issues ranging from minor to moderate that should be addressed for production reliability.

**Critical Issues:** 0
**High Issues:** 2
**Medium Issues:** 5
**Low Issues:** 4

---

## HIGH Issues

### H1: Hook Chaining Uses `;` -- Fragile When Hooks Already Contain `;`

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/claude-resurrect.tmux` (lines 19, 33)

**What's wrong:** When chaining with existing hooks, the code does:
```bash
tmux set-option -g "@resurrect-hook-post-save-all" "${existing_hook} ; ${save_script}"
```

The tmux-resurrect `execute_hook()` runs `eval "$hook $args"`. If `existing_hook` itself contains shell metacharacters, unescaped quotes, or fails mid-execution, the `;` chaining can break in unexpected ways. More importantly, if the plugin is loaded multiple times (e.g., user runs `prefix + I` again or sources tmux.conf again), the hook **accumulates duplicate entries**:

```
save.sh ; save.sh ; save.sh
```

**Why it matters:** Each tmux config reload appends another copy of the save/restore script to the hook. This causes the save/restore to run multiple times per operation, which is wasteful and could cause race conditions with the temp file.

**Suggested fix:** Before appending, check if the hook already contains the script path:
```bash
set_save_hook() {
    local save_script="$CURRENT_DIR/scripts/save.sh"
    local existing_hook
    existing_hook=$(get_tmux_option "@resurrect-hook-post-save-all" "")

    # Don't add if already present (idempotent)
    if [[ "$existing_hook" == *"$save_script"* ]]; then
        return 0
    fi

    if [ -n "$existing_hook" ]; then
        tmux set-option -g "@resurrect-hook-post-save-all" "${existing_hook} ; ${save_script}"
    else
        tmux set-option -g "@resurrect-hook-post-save-all" "$save_script"
    fi
}
```

---

### H2: `restore.sh` Resume Command is Vulnerable to Shell Injection via `cwd` or `session_id`

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/restore.sh` (line 59)

**What's wrong:** The resume command is built with string interpolation:
```bash
local resume_cmd="cd '${cwd}' && claude --resume '${session_id}'"
```

If `cwd` contains a single quote (e.g., `/home/user/it's-a-project`), this breaks:
```
cd 'it's-a-project'  # broken quoting
```

The `session_id` is a UUID (validated by regex during save), so it's safe. But `cwd` comes from the save file, which stores the tmux pane's `pane_current_path`, and directory names can contain single quotes.

**Why it matters:** Broken quoting causes the restore command to fail or, in adversarial cases, execute unintended commands.

**Suggested fix:** Use `printf %q` to safely escape the path:
```bash
local escaped_cwd
printf -v escaped_cwd '%q' "$cwd"
local resume_cmd="cd ${escaped_cwd} && claude --resume '${session_id}'"
```

---

## MEDIUM Issues

### M1: No Shebang on Sourced Library Files

**Files:**
- `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/variables.sh`
- `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/helpers.sh`
- `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/claude_helpers.sh`

**What's wrong:** These files lack a `#!/usr/bin/env bash` shebang. While they are intended to be sourced (not executed directly), adding a shebang serves as documentation and ensures consistent behavior if someone does run them directly or if an IDE/linter processes them.

**Why it matters:** Minor -- affects tooling and readability. ShellCheck would also require it for standalone analysis.

**Suggested fix:** Add `#!/usr/bin/env bash` as the first line of each file (before the comment).

---

### M2: `get_claude_pid_from_pane()` Only Searches 2 Levels Deep

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/claude_helpers.sh` (lines 15-48)

**What's wrong:** The function checks: pane_pid itself, direct children, and grandchildren. This covers the common `zsh -> claude` case (confirmed by live process tree analysis). However, if a user runs Claude inside a script, `tmux run-shell`, or a virtual env activation wrapper, the tree could be deeper.

**Why it matters:** Moderate -- the common case (shell -> claude) works perfectly. Deeper trees are edge cases but possible with custom shell setups (e.g., `zsh -> direnv -> bash -> claude`).

**Suggested fix:** Consider a recursive search with a configurable depth limit, or use `pgrep -P` with `--ancestor` if available:
```bash
# Alternative: search all descendants up to depth N
get_claude_pid_from_pane() {
    local pane_pid="$1"
    local max_depth="${2:-3}"
    local pids_at_level=("$pane_pid")

    for (( depth=0; depth<=max_depth; depth++ )); do
        for pid in "${pids_at_level[@]}"; do
            local cmd
            cmd=$(ps -p "$pid" -o comm= 2>/dev/null)
            if [ "$cmd" = "claude" ]; then
                echo "$pid"
                return 0
            fi
        done
        # Get all children of current level
        local next_level=()
        for pid in "${pids_at_level[@]}"; do
            while read -r child; do
                [ -n "$child" ] && next_level+=("$child")
            done < <(ps --ppid "$pid" -o pid= 2>/dev/null)
        done
        [ ${#next_level[@]} -eq 0 ] && break
        pids_at_level=("${next_level[@]}")
    done
    return 1
}
```

**Current assessment:** The existing 2-level search works for the confirmed process tree (`zsh -> claude`). This is a robustness improvement, not a bug fix.

---

### M3: `get_recent_session_for_dir()` Uses `ls -t` Parsing -- Fragile

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/claude_helpers.sh` (line 94)

**What's wrong:**
```bash
recent_file=$(ls -t "$project_path"/*.jsonl 2>/dev/null | head -1)
```

Parsing `ls` output is a well-known antipattern. If a `.jsonl` filename contains a newline (unlikely but possible), this breaks. Also, if there are no `.jsonl` files, the glob expands to the literal string `*.jsonl` in some shell configurations.

**Why it matters:** In practice, Claude generates UUID-named `.jsonl` files so this is safe. But it's not robust by shell scripting standards.

**Suggested fix:**
```bash
get_recent_session_for_dir() {
    local dir="$1"
    local slug
    slug=$(path_to_project_slug "$dir")
    local project_path="$CLAUDE_PROJECTS_DIR/${slug}"

    if [ -d "$project_path" ]; then
        local recent_file=""
        local recent_time=0
        for f in "$project_path"/*.jsonl; do
            [ -f "$f" ] || continue
            local mtime
            mtime=$(stat -c %Y "$f" 2>/dev/null) || continue
            if [ "$mtime" -gt "$recent_time" ]; then
                recent_time="$mtime"
                recent_file="$f"
            fi
        done
        if [ -n "$recent_file" ]; then
            basename "$recent_file" .jsonl
            return 0
        fi
    fi
    return 1
}
```

---

### M4: `save.sh` Temp File Not Cleaned Up on Failure

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/save.sh` (lines 23-43)

**What's wrong:** A temp file `${save_file}.tmp.$$` is created but there's no `trap` to clean it up if the script is interrupted (SIGINT, SIGTERM, or if `tmux list-panes` fails).

**Why it matters:** Orphaned `.tmp.*` files accumulate in the resurrect directory over time.

**Suggested fix:** Add a trap at the start of `save_claude_sessions()`:
```bash
save_claude_sessions() {
    local save_file
    save_file=$(get_claude_save_file)
    local save_dir
    save_dir=$(dirname "$save_file")
    mkdir -p "$save_dir"

    local tmp_file="${save_file}.tmp.$$"
    trap 'rm -f "$tmp_file"' EXIT INT TERM
    : > "$tmp_file"
    # ... rest of function
}
```

---

### M5: `verify_session_exists()` Uses `find` -- Inefficient

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/claude_helpers.sh` (lines 134-139)

**What's wrong:**
```bash
found=$(find "$CLAUDE_PROJECTS_DIR" -name "${session_id}.jsonl" -type f 2>/dev/null | head -1)
```

This traverses all project directories to find the session file. Since we already know the `cwd` at restore time (it's in the save file), we could compute the exact path and check directly.

**Why it matters:** Performance -- `find` across all projects is O(n) where n is the number of projects. Direct path check is O(1). With many projects this adds latency during restore.

**Suggested fix:** Pass `cwd` to `verify_session_exists` and check the expected path directly:
```bash
verify_session_exists() {
    local session_id="$1"
    local cwd="$2"

    if [ -n "$cwd" ]; then
        local slug
        slug=$(path_to_project_slug "$cwd")
        local expected_path="$CLAUDE_PROJECTS_DIR/${slug}/${session_id}.jsonl"
        [ -f "$expected_path" ] && return 0
    fi

    # Fallback to find if cwd not provided
    local found
    found=$(find "$CLAUDE_PROJECTS_DIR" -name "${session_id}.jsonl" -type f 2>/dev/null | head -1)
    [ -n "$found" ] && [ -f "$found" ]
}
```

Then in `restore.sh`, call: `verify_session_exists "$session_id" "$cwd"`

---

## LOW Issues

### L1: `get_tmux_option()` Fails Silently Outside Tmux

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/helpers.sh` (lines 3-13)

**What's wrong:** If the script is run outside a tmux session (e.g., for testing), `tmux show-option` writes an error to stderr and returns empty. The function falls through to the default value, which is correct behavior. However, the test script's `get_resurrect_dir` test relies on this fallback, meaning the test only exercises the fallback path, never the actual tmux integration.

**Why it matters:** The unit tests don't test the actual tmux integration path. Consider adding integration tests that run inside tmux.

---

### L2: Test Script Doesn't Test `get_claude_pid_from_pane()` or `get_claude_session_for_pane()`

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/test_plugin.sh`

**What's wrong:** The test only covers `path_to_project_slug`, `get_resurrect_dir`, and session extraction. The core detection functions (`get_claude_pid_from_pane`, `get_claude_session_for_pane`) and the save/restore flows are not tested.

**Why it matters:** The most critical and complex logic is untested.

**Suggested fix:** Add tests that mock `ps` output or use the actual running Claude process for integration testing.

---

### L3: `extract_session_from_cmdline()` Regex Uses `-r` Short Flag -- Could Match Unrelated Args

**File:** `/mnt/d/repo/github/tpm-plugin-tmux-ressurect-claude-code/scripts/claude_helpers.sh` (line 69)

**What's wrong:**
```bash
session_id=$(echo "$cmdline" | grep -oP -- '(--resume|-r)\s+\K[0-9a-f]{8}-...')
```

The `-r` pattern could match if some other flag `-r` is followed by something that looks like a UUID. In Claude CLI, `-r` is exclusively the short form of `--resume`, so this is correct. But if Claude ever adds another `-r` flag, this could break.

**Why it matters:** Very low risk given Claude's current CLI design. The regex requires a valid UUID to follow, which provides strong validation.

---

### L4: No `set -e` or `set -euo pipefail` in Scripts

**Files:** `save.sh`, `restore.sh`

**What's wrong:** The scripts don't use strict mode. A failing command mid-execution won't halt the script.

**Why it matters:** For hook scripts that run inside `eval`, `set -e` can be dangerous (it can cause the parent resurrect script to exit). So **not** using `set -e` is actually the correct choice here. This is noted as a low issue only for documentation purposes -- the current approach is intentional and correct.

---

## Verified Working Correctly

The following aspects were verified and work correctly:

1. **Path slugification** -- `path_to_project_slug()` produces `-mnt-d-repo-foo` which matches Claude's actual directory naming (verified against `~/.claude/projects/`).

2. **Claude process detection** -- `get_claude_pid_from_pane()` uses `ps -o comm=` looking for "claude". Live process inspection confirms Claude 2.x is a native ELF binary (not a Node.js process), and `comm` shows "claude". The function correctly handles the `shell -> claude` process tree.

3. **Session ID extraction from /proc/cmdline** -- `tr '\0' ' '` correctly converts null-byte separators to spaces. The grep regex correctly matches UUID format. Verified against live `/proc/<pid>/cmdline` data for both `--resume <uuid>` and non-resume processes.

4. **Fallback to recent session file** -- When Claude is started without `--resume` (no session ID in cmdline), `get_recent_session_for_dir()` finds the most recent `.jsonl` file. This is the correct fallback.

5. **Hook chaining pattern** -- The `;` chaining works with tmux-resurrect's `eval "$hook"` execution model. The hooks are called without args for `post-save-all` and `post-restore-all`.

6. **Restore mode (prompt vs auto)** -- The `prompt` mode uses `send-keys` without `C-m` (no Enter), correctly pre-typing the command. The `auto` mode appends `C-m` to execute immediately.

7. **Edge cases handled:**
   - No Claude sessions: `count` stays 0, no message displayed, empty save file created (harmless).
   - Claude not installed: `command -v claude` check returns early.
   - Missing resurrect dir: `mkdir -p` ensures directory exists before save.
   - Pane already running Claude on restore: `get_claude_pid_from_pane` check prevents duplicate launches.
   - Missing save file on restore: Early return on `[ ! -f "$save_file" ]`.
   - Target pane doesn't exist after restore: `tmux has-session` and `tmux display-message` checks.

8. **File permissions** -- All `.sh` and `.tmux` files have execute permission.

9. **Plugin enabled check** -- Both save and restore check `plugin_enabled()` before proceeding.

10. **Atomic save** -- Uses temp file + `mv` for atomic replacement of the save file.

---

## Recommendations Priority

| Priority | Issue | Effort |
|----------|-------|--------|
| HIGH | H1: Idempotent hook registration | Small |
| HIGH | H2: Shell injection in resume command | Small |
| MEDIUM | M4: Trap for temp file cleanup | Small |
| MEDIUM | M1: Add shebangs to library files | Trivial |
| MEDIUM | M5: Direct path check in verify_session_exists | Small |
| MEDIUM | M3: Replace ls parsing | Medium |
| MEDIUM | M2: Deeper process tree search | Medium |
| LOW | L2: Add integration tests | Large |
| LOW | L1: Test tmux integration paths | Medium |

---

## Conclusion

The plugin is fundamentally sound. The core save/restore flow, Claude detection, session extraction, and hook integration all work correctly for the standard use case. The two high-priority issues (idempotent hook registration and shell injection in the resume command) should be fixed before release. The medium issues are robustness improvements that would make the plugin more resilient to edge cases.
